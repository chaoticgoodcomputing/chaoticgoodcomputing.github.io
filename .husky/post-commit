#!/bin/bash
# Post-commit hook: Automatically commit changes in private submodule

# Unset git environment variables that might interfere with submodule operations
unset GIT_DIR
unset GIT_WORK_TREE
unset GIT_INDEX_FILE

source "$(dirname "$0")/submodule-helpers.sh"

# Check if there are any changes in the submodule
if [ -d "$SUBMODULE_PATH" ] && [ -e "$SUBMODULE_PATH/.git" ]; then
  # Check for changes in a subshell
  HAS_CHANGES=$(
    cd "$SUBMODULE_PATH" 2>/dev/null || exit 0
    if ! git diff --quiet 2>/dev/null || ! git diff --cached --quiet 2>/dev/null || [ -n "$(git ls-files --others --exclude-standard 2>/dev/null)" ]; then
      echo "yes"
    fi
  )
  
  if [ "$HAS_CHANGES" = "yes" ]; then
    # Wait briefly to ensure main repo commit has fully completed
    sleep 0.2
    
    echo ""
    echo "üìù Detected changes in $SUBMODULE_NAME..."
    
    # Get the commit message from the main repo
    MAIN_COMMIT_MSG=$(git log -1 --pretty=%B)
    
    # Use retry logic for submodule commit in case of transient lock issues
    (
      cd "$SUBMODULE_PATH" || exit 0
      
      if retry_with_backoff git add -A && retry_with_backoff git commit -m "'Sync: $MAIN_COMMIT_MSG'"; then
        echo -e "${GREEN}‚úì $SUBMODULE_NAME: commit successful${NC}"
      else
        echo -e "${YELLOW}‚ö†Ô∏è  $SUBMODULE_NAME: could not commit changes${NC}"
        echo -e "${YELLOW}   You may need to commit manually in $SUBMODULE_PATH${NC}"
      fi
    )
    
    echo ""
    echo "üí° Tip: Changes in $SUBMODULE_NAME are committed but not pushed."
    echo "   Run 'git push' to sync both repositories."
  fi
fi

exit 0
