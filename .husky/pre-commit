#!/bin/bash
# Pre-commit hook: Extract private metadata before committing

# Unset git environment variables
unset GIT_DIR
unset GIT_WORK_TREE
unset GIT_INDEX_FILE

source "$(dirname "$0")/submodule-helpers.sh"

SUBMODULE_PATH="content/private"
PUBLIC_DIR="content/public"
SYNC_MARKER="content/public/assets/PRIVATE_VAULT_LAST_SYNC.md"

# Check if submodule exists and is accessible
if [ ! -d "$SUBMODULE_PATH" ]; then
  echo -e "${YELLOW}‚ö†Ô∏è  Private content submodule not found - skipping metadata extraction${NC}"
  exit 0
fi

if [ ! -e "$SUBMODULE_PATH/.git" ]; then
  echo -e "${YELLOW}‚ö†Ô∏è  Private content submodule not initialized - skipping metadata extraction${NC}"
  exit 0
fi

# Check if remote is accessible (optional - extraction can work offline)
if ! check_remote_access 2>/dev/null; then
  echo -e "${YELLOW}‚ö†Ô∏è  Private content remote not accessible (working offline)${NC}"
fi

# Check if there are uncommitted changes in the private submodule
SUBMODULE_HAS_CHANGES=false
if (cd "$SUBMODULE_PATH" && ! git diff --quiet 2>/dev/null) || \
   (cd "$SUBMODULE_PATH" && ! git diff --cached --quiet 2>/dev/null) || \
   [ -n "$(cd "$SUBMODULE_PATH" && git ls-files --others --exclude-standard 2>/dev/null)" ]; then
  SUBMODULE_HAS_CHANGES=true
  echo ""
  echo "üìù Detected uncommitted changes in private vault - will sync after extraction"
fi

# Run the extraction script
echo ""
echo "üîÑ Extracting private metadata..."

if node utils/extract-private-metadata.mjs; then
  # Give the file system a moment to flush writes
  sleep 0.1
  
  # Stage all changes in public directory for this commit
  # This ensures extracted metadata is included in the current commit
  if [ -d "$PUBLIC_DIR" ]; then
    echo "üìù Staging extracted metadata files..."
    
    # Retry git add in case of transient lock issues
    if ! retry_with_backoff git add "$PUBLIC_DIR/"; then
      echo -e "${YELLOW}‚ö†Ô∏è  Could not stage public files - they will be in next commit${NC}"
    fi
  fi
  
  # If submodule has changes, update the sync marker to trigger a commit
  if [ "$SUBMODULE_HAS_CHANGES" = true ]; then
    echo "üìå Updating sync marker for private vault changes..."
    echo "Last synced: $(date -u +"%Y-%m-%dT%H:%M:%SZ")" > "$SYNC_MARKER"
    echo "" >> "$SYNC_MARKER"
    echo "This file is automatically updated when the private vault has changes." >> "$SYNC_MARKER"
    echo "It ensures the main repository tracks private vault state changes." >> "$SYNC_MARKER"
    
    if ! retry_with_backoff git add "$SYNC_MARKER"; then
      echo -e "${YELLOW}‚ö†Ô∏è  Could not stage sync marker - continuing anyway${NC}"
    fi
  fi
  
  echo ""
else
  echo -e "${YELLOW}‚ö†Ô∏è  Metadata extraction encountered issues (non-fatal)${NC}"
fi

exit 0

